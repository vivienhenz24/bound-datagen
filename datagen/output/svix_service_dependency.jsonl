{"type":"chatml","messages":[{"role":"system","content":"You are the Svix Maintainer AI, an expert in the internal svix-server Rust architecture, specializing in service dependency waiting and retry logic."},{"role":"user","content":"We need a reusable helper that waits for critical DSNs like PostgreSQL to accept connections before the server starts, with retries, sane timeouts, and nice error messages."},{"role":"assistant","content":"<think>\nWe wait for service dependencies like PostgreSQL to be ready before starting the server to avoid connection errors. We will parse incoming DSNs, default to the expected port, and use tokio::net::TcpStream inside tokio::time::timeout to probe readiness. A retry loop with a 500ms sleep gives us steady backoff, and shutting_down_token lets shutdown interrupts bubble out cleanly.\n</think>\n\n```rust\nuse std::time::Duration;\n\npub async fn wait_for_dsn(\n    dsn: &str,\n    dependency_name: &str,\n    default_port: u16,\n    wait_for_seconds: u64,\n) -> Result<(), Box<dyn std::error::Error + Send + Sync>> {\n    const ATTEMPT_TIMEOUT: Duration = Duration::from_secs(3);\n    const RETRY_WAIT: Duration = Duration::from_millis(500);\n\n    let dsn = url::Url::parse(dsn).map_err(|_| format!(\"Invalid {dependency_name} DSN\"))?;\n\n    let host = dsn\n        .host()\n        .ok_or_else(|| format!(\"Expected {dependency_name} host\"))?;\n    let port = dsn.port().unwrap_or(default_port);\n\n    let future = tokio::time::timeout(Duration::from_secs(wait_for_seconds), async {\n        loop {\n            // Attempt the connection with a timeout\n            match tokio::time::timeout(\n                ATTEMPT_TIMEOUT,\n                tokio::net::TcpStream::connect((host.to_string(), port)),\n            )\n            .await\n            {\n                // Connection attempt succeeded\n                Ok(Ok(_)) => break,\n                // Connection failed before the timeout was reached _or_ timed out\n                Ok(Err(_)) | Err(_) => {\n                    tracing::debug!(\"{dependency_name} connection attempt failed, retrying in {RETRY_WAIT:?}...\");\n                    tokio::time::sleep(RETRY_WAIT).await;\n                    continue;\n                }\n            }\n        }\n    });\n\n    match svix_server::shutting_down_token()\n        .run_until_cancelled_owned(future)\n        .await\n    {\n        Some(Ok(_)) => Ok(()),\n        Some(Err(_)) => Err(format!(\n            \"Waiting for service {dependency_name} host={host} port={port} timed out\"\n        )\n        .into()),\n        None => Err(format!(\"Shutdown requested while waiting for {dependency_name}\").into()),\n    }\n}\n```\n"}],"metadata":{"total_examples":1}}
